name: RK3128 OpenWrt Build (Fast Defconfig)
on:
  push:
    branches: [ main ]
  workflow_dispatch:
jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 120  # 缩短超时阈值，同时加快步骤
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: 终极清理（释放资源）
        run: rm -rf openwrt && rm -rf ~/.ccache && sudo apt-get clean && sync && sudo swapoff -a
      - name: Install Dependencies（极简依赖）
        run: sudo apt-get update && sudo apt-get install -y build-essential gcc-multilib g++-multilib gettext git libncurses5-dev libssl-dev python3 rsync unzip wget ccache
      - name: Clone OpenWrt 19.07（轻量化，RK3128适配成熟）
        run: git clone --depth=1 -b openwrt-19.07 https://github.com/openwrt/openwrt.git openwrt --config http.sslVerify=false
      - name: 配置镜像加速+删telephony feeds（核心加速）
        run: cd openwrt && sed -i '/telephony/d' feeds.conf.default && sed -i 's#openwrt.org#mirrors.tuna.tsinghua.edu.cn/openwrt#g' feeds.conf.default && ./scripts/feeds update -a -q > /dev/null 2>&1 && ./scripts/feeds install -y -q luci p910nd kmod-usb-printer > /dev/null 2>&1
      - name: 快速生成Rockchip/armv7配置（多核心+无冗余）
        run: cd openwrt && export TERM=xterm && make -j2 target/rockchip/armv7/defconfig > /dev/null 2>&1  # 适度多核心加快执行
      - name: 追加核心配置（静默+非交互）
        run: cd openwrt && export TERM=xterm && sed -i -e '$a CONFIG_ALL_N=y' -e '$a CONFIG_PACKAGE_p910nd=y' -e '$a CONFIG_PACKAGE_kmod-usb-printer=y' -e '$a CONFIG_PACKAGE_luci-app-p910nd=y' -e '$a CONFIG_PACKAGE_luci=y' .config && make -j2 olddefconfig > /dev/null 2>&1
      - name: 下载依赖（镜像加速+多核心）
        run: cd openwrt && export TERM=xterm && make -j2 download > /dev/null 2>&1
      - name: 编译固件（限核心+静默）
        run: cd openwrt && export TERM=xterm && make -s -j$(($(nproc)-1)) V=0  # 最大化利用核心，缩短编译时间
      - name: 上传固件（ARMv7优先）
        uses: actions/upload-artifact@v4
        with:
          name: rk3128-openwrt-firmware
          path: |
            openwrt/bin/targets/rockchip/armv7/*
          if-no-files-found: warn
