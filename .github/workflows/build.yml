name: RK3128 OpenWrt Build (Lean + Ubuntu22.04 + No Menuconfig)
on:
  push:
    branches: [ main ]
  workflow_dispatch:
jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 240
    steps:
      - name: 步骤1：代码检出
        uses: actions/checkout@v4

      - name: 步骤2：终极清理
        run: rm -rf openwrt && rm -rf ~/.ccache && sudo apt-get clean && sync && sudo swapoff -a

      - name: 步骤3：安装完整依赖（消除所有警告）
        run: |
          sudo apt-get update
          # 核心编译依赖 + Lean版缺失的系统依赖
          sudo apt-get install -y build-essential gcc-multilib g++-multilib gettext git \
          libncurses5-dev libssl-dev python3 rsync unzip wget ccache u-boot-tools \
          libpam0g-dev liblzma-dev libncursesw5-dev libcap-dev \
          bc pciutils lm-sensors wsdd2 jq ntpdate smartmontools coreutils gperf \
          libunistring-dev libxml2-dev libpcre2-dev libcurl4-openssl-dev libtins-dev \
          libyaml-cpp-dev libglib2.0-dev libgpiod-dev libtirpc-dev libaio-dev
        # 检查点：无“无法定位包”，所有依赖安装成功

      - name: 步骤4：克隆Lean版OpenWrt
        run: git clone --depth=1 https://github.com/coolsnowwolf/lede.git openwrt --config http.sslVerify=false

      - name: 步骤5：Feeds配置（仅装核心包，禁用冗余）
        run: |
          cd openwrt
          ./scripts/feeds update -a
          # 仅安装RK3128+打印服务+LuCI核心包，不装Lean冗余组件
          ./scripts/feeds install -y luci luci-app-p910nd p910nd kmod-usb-printer

      - name: 步骤6：生成完整.config（禁用Lean冗余组件，避免交互）
        run: |
          cd openwrt
          export TERM=xterm
          # 生成完整配置，禁用Lean冗余组件，避免配置不全
          cat > .config << EOF
CONFIG_TARGET_rockchip=y
CONFIG_TARGET_rockchip_armv7=y
CONFIG_TARGET_rockchip_armv7_DEVICE_firefly-rk3128=y
CONFIG_PACKAGE_p910nd=y
CONFIG_PACKAGE_kmod-usb-printer=y
CONFIG_PACKAGE_luci-app-p910nd=y
CONFIG_PACKAGE_luci=y
CONFIG_PACKAGE_luci-theme-argon=y
# 禁用Lean冗余组件，消除依赖警告
CONFIG_PACKAGE_luci-app-autocore=n
CONFIG_PACKAGE_luci-app-autosamba=n
CONFIG_PACKAGE_luci-app-ddns=n
CONFIG_PACKAGE_luci-app-fogvdn=n
CONFIG_PACKAGE_luci-app-samba=n
CONFIG_PACKAGE_kexec-tools=n
CONFIG_PACKAGE_lldpd=n
CONFIG_PACKAGE_policycoreutils=n
# 核心：禁用全选，避免配置不全
CONFIG_ALL=n
CONFIG_ALL_KMODS=n
CONFIG_ALL_NONSHARED=n
CONFIG_DEVEL=y
CONFIG_TOOLCHAINOPTS=y
EOF
          # 调和配置，强制使用现有.config
          make -j1 olddefconfig CONFIG_DEFCONFIG_LIST=.config

      - name: 步骤7：下载依赖包（静默）
        run: cd openwrt && export TERM=xterm && make -j1 download > /dev/null 2>&1

      - name: 步骤8：强制静默编译（禁用menuconfig交互）
        run: cd openwrt && export TERM=xterm && make -s -j$(($(nproc)-1)) FORCE=1 CONFIG_DEFCONFIG_LIST=.config V=0
        # 核心：FORCE=1 + CONFIG_DEFCONFIG_LIST=.config 禁用交互

      - name: 步骤9：上传固件
        uses: actions/upload-artifact@v4
        with:
          name: rk3128-openwrt-lean-firmware
          path: |
            openwrt/bin/targets/rockchip/armv7/*
          if-no-files-found: error
