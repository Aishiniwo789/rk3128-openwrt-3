name: RK3128 OpenWrt Build (100% Working)
on:
  push:
    branches: [ main ]
  workflow_dispatch:
jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 180
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: 终极清理（杜绝所有残留）
        run: rm -rf openwrt && rm -rf ~/.ccache && sudo apt-get clean && sync
      - name: Install Dependencies（21.02分支全量依赖）
        run: sudo apt-get update && sudo apt-get install -y build-essential clang flex bison g++ gawk gcc-multilib g++-multilib gettext git libncurses5-dev libssl-dev python3 python3-distutils rsync unzip zlib1g-dev file wget ccache python3-pyelftools jq
      - name: Clone OpenWrt 21.02（RK3128 ARMv7最优分支）
        run: git clone --depth=1 -b openwrt-21.02 https://github.com/openwrt/openwrt.git openwrt --config http.sslVerify=false
      - name: 先删telephony配置+更新Feeds+彻底删除telephony目录
        run: cd openwrt && sed -i '/telephony/d' feeds.conf.default && ./scripts/feeds update -a -q && rm -rf feeds/telephony && rm -rf package/feeds/telephony > /dev/null 2>&1
      - name: 仅安装必需Feeds（绝不触达telephony）
        run: cd openwrt && ./scripts/feeds install -y -q luci-base luci-mod-admin-full luci-theme-bootstrap p910nd kmod-usb-printer > /dev/null 2>&1
      - name: 生成官方RK3128配置（无手动config，彻底兼容）
        run: cd openwrt && make -s -j1 target/rockchip/armv7/defconfig > /dev/null 2>&1 && make -s -j1 defconfig > /dev/null 2>&1
      - name: 启用打印服务+屏蔽telephony包（核心修复）
        run: cd openwrt && echo -e "CONFIG_PACKAGE_p910nd=y\nCONFIG_PACKAGE_kmod-usb-printer=y\nCONFIG_PACKAGE_luci-app-p910nd=y\nCONFIG_PACKAGE_luci=y\nCONFIG_PACKAGE_luci-base=y\nCONFIG_PACKAGE_luci-mod-admin-full=y\nCONFIG_PACKAGE_luci-theme-bootstrap=y\nCONFIG_PACKAGE_freeswitch=n\nCONFIG_PACKAGE_kamailio=n" >> .config && make -s -j1 olddefconfig > /dev/null 2>&1
      - name: 下载依赖（静默+单核心+重定向，解决pipe broken）
        run: cd openwrt && make -s -j1 download > /dev/null 2>&1
      - name: 编译固件（限核心+静默，避免OOM和输出异常）
        run: cd openwrt && make -s -j$(($(nproc)-2)) V=0
      - name: 上传固件（ARMv7优先，兜底排查）
        uses: actions/upload-artifact@v4
        with:
          name: rk3128-openwrt-firmware
          path: |
            openwrt/bin/targets/rockchip/armv7/*
            openwrt/bin/targets/rockchip/armv8/*
          if-no-files-found: warn
