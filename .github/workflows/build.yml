name: RK3128 OpenWrt Build (18.06.9 + ubuntu-latest)
on:
  push:
    branches: [ main ]
  workflow_dispatch:
jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 240
    steps:
      - name: 步骤1：代码检出
        uses: actions/checkout@v4

      - name: 步骤2：终极清理
        run: rm -rf openwrt && rm -rf ~/.ccache && sudo apt-get clean && sync && sudo swapoff -a

      - name: 步骤3：安装适配依赖（ubuntu22.04 + OpenWrt18.06.9）
        run: |
          sudo apt-get update
          # 核心：添加deadsnakes仓库（ubuntu22.04获取python2.7的唯一途径）
          sudo apt-get install -y software-properties-common
          sudo add-apt-repository -y ppa:deadsnakes/ppa
          sudo apt-get update
          # 安装Python2.7 + 核心编译依赖
          sudo apt-get install -y build-essential gcc-multilib g++-multilib gettext git \
          libncurses5-dev libssl-dev python2.7 rsync unzip wget ccache u-boot-tools \
          libpam0g-dev liblzma-dev libncursesw5-dev libcap-dev
          # 创建Python软链接（让OpenWrt18.06找到Python2）
          sudo ln -sf /usr/bin/python2.7 /usr/bin/python
          # 验证Python版本（确保安装成功）
          python --version
        # 检查点：输出“Python 2.7.x”，无“无法定位包”错误

      - name: 步骤4：克隆OpenWrt 18.06.9（完整git历史）
        run: git clone -b v18.06.9 https://github.com/openwrt/openwrt.git openwrt --config http.sslVerify=false

      - name: 步骤5：Feeds配置（适配RK3128）
        run: |
          cd openwrt
          sed -i '/telephony/d' feeds.conf.default 2>/dev/null
          ./scripts/feeds update -a
          ./scripts/feeds install -y luci luci-app-p910nd p910nd kmod-usb-printer

      - name: 步骤6：生成RK3128专属配置
        run: |
          cd openwrt
          export TERM=xterm
          make -j1 TARGET=rockchip SUBTARGET=armv7 defconfig
          echo -e "CONFIG_TARGET_rockchip_armv7_DEVICE_firefly-rk3128=y\nCONFIG_PACKAGE_p910nd=y\nCONFIG_PACKAGE_kmod-usb-printer=y\nCONFIG_PACKAGE_luci-app-p910nd=y\nCONFIG_PACKAGE_luci=y\nCONFIG_PACKAGE_luci-theme-bootstrap=y" >> .config
          make -j1 olddefconfig

      - name: 步骤7：下载依赖包
        run: cd openwrt && export TERM=xterm && make -j1 download

      - name: 步骤8：编译固件
        run: cd openwrt && export TERM=xterm && make -j$(($(nproc)-1)) V=0

      - name: 步骤9：上传固件
        uses: actions/upload-artifact@v4
        with:
          name: rk3128-openwrt-18.06.9-firmware
          path: |
            openwrt/bin/targets/rockchip/armv7/*
          if-no-files-found: error
